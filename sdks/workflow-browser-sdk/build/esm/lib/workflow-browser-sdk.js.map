{"version":3,"file":"workflow-browser-sdk.js","sources":["../../../src/lib/workflow-browser-sdk.ts"],"sourcesContent":["import {\n  createWorkflow,\n  WorkflowEventWithoutState\n} from '@ballerine/workflow-core';\nimport type {\n  BaseActionObject,\n  EventObject,\n  StateNodeConfig,\n  StatesConfig\n} from 'xstate';\nimport { assign } from 'xstate';\nimport { backendOptions } from './backend-options';\nimport { Action, Error, Errors, Event } from './enums';\nimport type {\n  BackendOptions,\n  BrowserWorkflowEvent,\n  IOnProps,\n  IUserStepEvent,\n  ObjectValues,\n  TSubscribers,\n  TWorkflowErrorEvent,\n  TWorkflowEvent,\n  TWorkflowHttpErrorEvent,\n  WorkflowEventWithBrowserType,\n  WorkflowOptionsBrowser\n} from './types';\n\nexport class WorkflowBrowserSDK {\n  #__subscribers: TSubscribers = [];\n  #__service: ReturnType<typeof createWorkflow>;\n  #__backendOptions: BackendOptions;\n\n  constructor({ backend, ...options }: WorkflowOptionsBrowser) {\n    this.#__backendOptions = {\n      ...backendOptions,\n      ...backend,\n      endpoints: {\n        persist: {\n          ...backendOptions.endpoints.persist,\n          ...backend?.endpoints?.persist,\n        },\n        submit: {\n          ...backendOptions.endpoints.submit,\n          ...backend?.endpoints?.submit,\n        },\n      },\n      headers: {\n        ...backendOptions.headers,\n        ...backend?.headers,\n      },\n    };\n\n    // Actions defined within the machine's `states` object.\n    const states = this.#__injectUserStepActionsToStates(\n      options?.workflowDefinition?.states ?? {},\n    );\n    // const states = this.#__injectSubmitActorToStates(states);\n\n    // Actions defined within `createMachine`'s second argument (config object).\n\n    this.#__service = createWorkflow({\n      ...options,\n      extensions: {\n        statePlugins: [\n          {\n            stateNames: options?.persistStates ?? [],\n            name: 'persist',\n            when: 'entry',\n            action: async ({ context }) => {\n              const { baseUrl, endpoints, headers } = this.#__backendOptions;\n              const { endpoint, method } = endpoints?.persist;\n              const url = baseUrl ? new URL(endpoint, baseUrl) : endpoint;\n\n              try {\n                await new Promise(resolve => setTimeout(resolve, 2000));\n\n                const res = await fetch(url, {\n                  method,\n                  body: JSON.stringify(context),\n                  headers: {\n                    'Content-Type': 'application/json',\n                    ...headers,\n                  },\n                });\n\n                if (!res.ok) {\n                  throw res;\n                }\n              } catch (err) {\n                if (!(err instanceof Response)) {\n                  throw err;\n                }\n\n                // throw new HttpError(\n                //   err.status,\n                //   `Response error: ${err.statusText} (${err.status})`,\n                //   {\n                // cause: err,\n                //   },\n                // );\n              }\n            },\n          },\n        ],\n        globalPlugins: [],\n      },\n      workflowDefinition: {\n        ...options?.workflowDefinition,\n        states,\n      },\n      workflowActions: {\n        [Action.USER_NEXT_STEP]: assign<\n          Record<PropertyKey, any>,\n          IUserStepEvent\n        >((context, event) => {\n          context = {\n            ...context,\n            ...event.payload,\n          };\n\n          return context;\n        }),\n        [Action.USER_PREV_STEP]: assign<\n          Record<PropertyKey, any>,\n          IUserStepEvent\n        >((context, event) => {\n          context = {\n            ...context,\n            ...event.payload,\n          };\n\n          return context;\n        }),\n      },\n    });\n\n    this.#__service.subscribe(event => {\n      this.#__notify(event);\n    });\n  }\n\n  #__notify({\n    type,\n    payload,\n    state,\n  }: //  error\n  WorkflowEventWithBrowserType) {\n    this.#__subscribers.forEach(sub => {\n      if (\n        sub.event !== Event.WILD_CARD &&\n        !(\n          sub.event === Event.ERROR &&\n          Errors.includes(type as ObjectValues<typeof Error>)\n        ) &&\n        sub.event !== type\n      ) {\n        return;\n      }\n\n      sub.cb({\n        type:\n          sub.event === Event.WILD_CARD || sub.event === Event.ERROR\n            ? type\n            : undefined,\n        payload,\n        state,\n        // error,\n      });\n    });\n  }\n\n  subscribe<TEvent extends BrowserWorkflowEvent>(\n    event: TEvent,\n    cb: TEvent extends typeof Event.WILD_CARD\n      ? (event: WorkflowEventWithBrowserType) => void\n      : TEvent extends typeof Error.ERROR\n      ? (event: TWorkflowErrorEvent) => void\n      : TEvent extends typeof Error.HTTP_ERROR\n      ? (event: TWorkflowHttpErrorEvent) => void\n      : (event: TWorkflowEvent) => void,\n  ) {\n    this.#__subscribers.push({ event, cb });\n  }\n\n  sendEvent(event: WorkflowEventWithoutState) {\n    this.#__service.sendEvent(event);\n  }\n\n  getSnapshot() {\n    return this.#__service.getSnapshot();\n  }\n\n  /**\n   * Adds the `USER_NEXT_STEP` and `USER_PREV_STEP` actions to\n   * the machine states which include `on.USER_NEXT_STEP` and `on.USER_PREV_STEP`.\n   * @param states\n   * @private\n   */\n  #__injectUserStepActionsToStates(\n    states: StatesConfig<any, any, any, BaseActionObject>,\n  ) {\n    /**\n     * Make sure to not override existing actions.\n     * Actions may be a string, an array of strings or undefined.\n     * @param actions\n     * @param action - `USER_NEXT_STEP`, `USER_PREV_STEP`, or user defined action.\n     */\n    const getActions = (\n      // Actions is expected to be serializable.\n      actions: string | Array<string> | undefined,\n      action:\n        | typeof Action.USER_NEXT_STEP\n        | typeof Action.USER_PREV_STEP\n        | string,\n    ) => {\n      // Don't modify unrelated user defined actions.\n      if (\n        action !== Action.USER_NEXT_STEP &&\n        action !== Action.USER_PREV_STEP\n      ) {\n        return actions;\n      }\n\n      // Push the `USER_NEXT_STEP` or `USER_PREV_STEP` action to\n      // the existing `actions` array.\n      if (Array.isArray(actions)) return [...actions, action];\n\n      // Create a new array with the USER_NEXT_STEP/USER_PREV_STEP action,\n      // and the existing user defined action.\n      if (!!actions) return [actions, action];\n\n      // Fallback to unchanged actions.\n      return action;\n    };\n\n    /**\n     * Traverses multiple levels of the state machine's `states` object,\n     * injects the `USER_NEXT_STEP` and `USER_PREV_STEP` actions if needed,\n     * without overriding unrelated props which may be defined within the `on` object or an event's props which are not `target` or `actions`.\n     * @param outerKey\n     * @param outerValue\n     */\n    const reduceStateOnProp = ([outerKey, outerValue]: [\n      string,\n      (\n        | StateNodeConfig<unknown, any, EventObject>\n        | StatesConfig<unknown, any, EventObject>\n      ),\n    ]) => {\n      const on = Object.entries(outerValue?.on ?? {})?.reduce(\n        (state, [event, target]) => {\n          const nextTarget = target?.[event] ?? target?.target;\n          const eventProps =\n            typeof target === 'string'\n              ? { target }\n              : // i.e. the value of { USER_NEXT_STEP: [TARGET] }\n                {\n                  // { target: ..., actions: ... } etc.\n                  ...target,\n                  ...(nextTarget ? { target: nextTarget } : {}),\n                };\n          // Inject actions and honor user defined actions.\n          const actions = getActions(eventProps?.actions, event);\n\n          // Construct the new `on` object.\n          state[event] = {\n            // Ensure if there are props which are not target or actions,\n            // they don't get overridden.\n            ...eventProps,\n            ...(!eventProps?.invoke ? { actions } : {}),\n          };\n\n          return state;\n        },\n        {} as Record<string, IOnProps>,\n      );\n\n      // i.e. { WELCOME: { ..., on: { ... }, ... } }\n      const injected = {\n        ...outerValue,\n        // Avoid adding an empty `on` prop if it\n        // wasn't defined by the user originally.\n        ...(Object.keys(on).length ? { on } : {}),\n      };\n\n      return [outerKey, injected];\n    };\n\n    const statesEntries = Object.entries(states)\n      // Construct a new `on` object for each state.\n      .map(reduceStateOnProp);\n\n    return Object.fromEntries(statesEntries);\n  }\n}\n"],"names":["_subscribers","_classPrivateFieldLooseKey","_service","_backendOptions","_notify","_injectUserStepActionsToStates","WorkflowBrowserSDK","_ref","_backend$endpoints","_backend$endpoints2","_options$workflowDefi","_options$workflowDefi2","_options$persistState","_this","_workflowActions","backend","options","_objectWithoutPropertiesLoose","_excluded","Object","defineProperty","value","_injectUserStepActionsToStates2","_notify2","writable","_classPrivateFieldLooseBase","_extends","backendOptions","endpoints","persist","submit","headers","states","workflowDefinition","createWorkflow","extensions","statePlugins","stateNames","persistStates","name","when","action","_action","_asyncToGenerator","_regeneratorRuntime","mark","_callee","_ref2","context","_classPrivateFieldLoo","baseUrl","_endpoints$persist","endpoint","method","url","res","wrap","_callee$","_context","prev","next","URL","Promise","resolve","setTimeout","fetch","body","JSON","stringify","sent","ok","t0","Response","stop","_x","apply","arguments","globalPlugins","workflowActions","Action","USER_NEXT_STEP","assign","event","payload","USER_PREV_STEP","subscribe","_proto","prototype","cb","push","sendEvent","getSnapshot","_ref3","type","state","forEach","sub","Event","WILD_CARD","ERROR","Errors","includes","undefined","getActions","actions","Array","isArray","concat","reduceStateOnProp","_ref4","_Object$entries","_outerValue$on","outerKey","outerValue","on","entries","reduce","_ref5","_target$event","target","nextTarget","eventProps","invoke","injected","keys","length","statesEntries","map","fromEntries"],"mappings":"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"}
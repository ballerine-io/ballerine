datasource db {
  provider = "postgresql"
  url      = env("DB_URL")
}

generator client {
  provider = "prisma-client-js"
}

generator jsonSchema {
  provider = "prisma-json-schema-generator"
}

model User {
  id        String  @id @default(cuid())
  firstName String
  lastName  String
  email     String  @unique
  phone     String? @unique
  password  String
  roles     Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ApprovalState {
  APPROVED
  REJECTED
  PROCESSING
  NEW
}

model EndUser {
  id String @id @default(cuid())

  correlationId  String  @db.VarChar
  verificationId String? @db.VarChar

  endUserType   String?
  approvalState ApprovalState @default(NEW)
  stateReason   String?       @db.VarChar
  jsonData      Json?

  firstName      String?   @db.VarChar
  lastName       String?   @db.VarChar
  email          String?   @db.Text
  phone          String?   @db.VarChar
  dateOfBirth    DateTime?
  avatarUrl      String?
  additionalInfo Json?

  workflowRuntimeData WorkflowRuntimeData[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business   Business? @relation(fields: [businessId], references: [id])
  businessId String?
}

model Business {
  id                      String        @id @default(cuid()) // Unique identifier for the business entity
  createdAt               DateTime      @default(now()) // Timestamp for when the business entity was created
  updatedAt               DateTime      @updatedAt // Timestamp for when the business entity was last updated
  companyName             String // Official registered name of the business entity
  registrationNumber      String // Unique registration number assigned by the relevant authorities
  legalForm               String // Legal structure of the business entity, e.g., LLC, corporation, partnership
  countryOfIncorporation  String // Country where the business entity is incorporated
  dateOfIncorporation     DateTime? // Date when the business entity was incorporated
  address                 String // Registered address of the business entity
  phoneNumber             String? // Contact phone number of the business entity
  email                   String? // Contact email of the business entity
  website                 String? // Official website of the business entity
  industry                String // Industry sector the business entity operates in
  taxIdentificationNumber String? // Unique tax identification number assigned by the tax authorities
  vatNumber               String? // Unique VAT (Value Added Tax) number for the business entity
  endUsers                EndUser[]
  shareholderStructure    Json? // Information about the ownership structure, including shareholders and their ownership percentages
  numberOfEmployees       Int? // Number of employees working for the business entity
  businessPurpose         String? // Brief description of the business entity's purpose or main activities
  documents               Json // Collection of documents required for the KYB process, e.g., registration documents, financial statements
  approvalState           ApprovalState @default(PROCESSING) // Current status of the KYB process for the business entity
}

model WorkflowDefinition {
  id              String  @id @default(cuid())
  reviewMachineId String?
  name            String
  version         Int     @default(1)

  definitionType     String
  definition         Json
  supportedPlatforms Json?
  extensions         Json?

  backend       Json?
  persistStates Json?
  submitStates  Json?

  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  createdBy           String                @default("SYSTEM")
  workflowRuntimeData WorkflowRuntimeData[]
}

model WorkflowRuntimeData {
  id                        String             @id @default(cuid())
  endUser                   EndUser            @relation(fields: [endUserId], references: [id], onDelete: Cascade)
  endUserId                 String
  workflowDefinition        WorkflowDefinition @relation(fields: [workflowDefinitionId], references: [id])
  workflowDefinitionId      String
  workflowDefinitionVersion Int
  context                   Json
  // history
  state                     String?
  status                    String             @default("created")
  createdAt                 DateTime           @default(now())
  updatedAt                 DateTime           @updatedAt
  createdBy                 String             @default("SYSTEM")
}

model File {
  id             String   @id @default(cuid())
  userId         String
  fileNameOnDisk String
  createdAt      DateTime @default(now())
  createdBy      String   @default("SYSTEM")
}

model Policy {
  id        String @id @default(cuid())
  name      String
  version   Int
  tasks     Json
  rulesSets Json
}
